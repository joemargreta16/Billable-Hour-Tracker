{% extends "base.html" %}

{% block title %}Dashboard - Time Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-0">Dashboard</h1>
            <a href="{{ url_for('add_entry') }}" class="btn btn-primary">
                <i data-feather="plus" class="me-1"></i>Add Entry
            </a>
        </div>
        <div class="d-flex justify-content-between align-items-center">
            <p class="text-muted">{{ cycle_name }}</p>
            <form method="GET" action="{{ url_for('dashboard') }}">
                <select name="cycle" class="form-select form-select-sm" onchange="this.form.submit()">
                    {% for cycle in available_cycles %}
                        <option value="{{ cycle.start_date.strftime('%Y-%m-%d') }}" {% if cycle.start_date == start_date %}selected{% endif %}>{{ cycle.name }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i data-feather="clock" class="text-primary mb-2" style="width: 2rem; height: 2rem;"></i>
                <h4 class="mb-1">{{ decimal_to_hours_minutes(total_hours) }}</h4>
                <small class="text-muted">Total Hours</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i data-feather="target" class="text-success mb-2" style="width: 2rem; height: 2rem;"></i>
                <h4 class="mb-1">{{ decimal_to_hours_minutes(monthly_goal) }}</h4>
                <small class="text-muted">Monthly Goal</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i data-feather="clock" class="{% if remaining_hours > 0 %}text-warning{% else %}text-success{% endif %} mb-2" style="width: 2rem; height: 2rem;"></i>
                <h4 class="mb-1">{{ decimal_to_hours_minutes(remaining_hours) }}</h4>
                <small class="text-muted">Remaining</small>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i data-feather="trending-up" class="text-info mb-2" style="width: 2rem; height: 2rem;"></i>
                <h4 class="mb-1">{{ "%.1f"|format(progress_percentage) }}%</h4>
                <small class="text-muted">Progress</small>
            </div>
        </div>
    </div>
</div>

<!-- Progress Visualization -->
<div class="row mb-4">
    <div class="col-lg-8 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Monthly Progress</h5>
                <div class="progress mb-2" style="height: 1.5rem;">
                    <div class="progress-bar {% if progress_percentage >= 100 %}bg-success{% elif progress_percentage >= 75 %}bg-info{% elif progress_percentage >= 50 %}bg-warning{% else %}bg-primary{% endif %}" 
                         role="progressbar" 
                         style="width: {{ progress_percentage }}%"
                         aria-valuenow="{{ progress_percentage }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                         {{ "%.0f"|format(progress_percentage) }}%
                    </div>
                </div>
                <div class="d-flex justify-content-between text-muted small">
                    <span>{{ decimal_to_hours_minutes(total_hours) }} of {{ decimal_to_hours_minutes(monthly_goal) }} hours</span>
                    <span>Day {{ days_completed }} of {{ total_days }}</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 mb-3">

    </div>
</div>

<!-- Recent Entries and Daily Summary -->
<div class="row">
    <!-- Recent Entries -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Recent Entries</h5>
                <a href="{{ url_for('entries') }}" class="btn btn-sm btn-outline-secondary">View All</a>
            </div>
            <div class="card-body">
                {% if recent_entries %}
                    {% for entry in recent_entries %}
                        <div class="time-entry-card border rounded p-3 mb-3">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-1">
                                        <i data-feather="calendar" class="me-2 text-muted" style="width: 1rem; height: 1rem;"></i>
                                        <span class="fw-medium">{{ entry.date.strftime('%b %d, %Y') }}</span>
                                        <span class="badge bg-primary ms-2">{{ entry.hours_minutes_display }}</span>
                                    </div>
                                    <div class="d-flex align-items-center mb-1">
                                        <i data-feather="folder" class="me-2 text-muted" style="width: 1rem; height: 1rem;"></i>
                                        <span>{{ entry.project.name }}</span>
                                    </div>
                                    {% if entry.description %}
                                        <div class="text-muted small">{{ entry.description }}</div>
                                    {% endif %}
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('edit_entry', entry_id=entry.id) }}" class="btn btn-outline-secondary">
                                        <i data-feather="edit-2"></i>
                                    </a>
                                    <form method="POST" action="{{ url_for('delete_entry', entry_id=entry.id) }}" class="d-inline" 
                                          onsubmit="return confirm('Are you sure you want to delete this entry?')">
                                        <button type="submit" class="btn btn-outline-danger">
                                            <i data-feather="trash-2"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i data-feather="clock" class="mb-3" style="width: 3rem; height: 3rem;"></i>
                        <p>No time entries found for this cycle.</p>
                        <a href="{{ url_for('add_entry') }}" class="btn btn-primary">Add Your First Entry</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Daily Summary & Charts -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Daily Summary</h5>
            </div>
            <div class="card-body">
                {% if daily_totals %}
                    <!-- Daily Chart -->
                    <div class="mb-3">
                        <canvas id="dailyChart" height="200"></canvas>
                    </div>
                    
                    <!-- Daily List -->
                    <div class="daily-summary" style="max-height: 250px; overflow-y: auto;">
                        {% for day_total in daily_totals[:10] %}
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <span class="text-muted">{{ day_total.date.strftime('%m/%d') }}</span>
                                <span class="badge bg-secondary">{{ decimal_to_hours_minutes(day_total.total_hours) }}</span>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center text-muted py-3">
                        <i data-feather="calendar" class="mb-2" style="width: 2rem; height: 2rem;"></i>
                        <p class="mb-0">No daily data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if progress_percentage >= 100 %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-success">
            <i data-feather="check-circle" class="me-2"></i>
            <strong>Congratulations!</strong> You've reached your monthly goal of {{ decimal_to_hours_minutes(monthly_goal) }} hours!
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Refresh feather icons after content loads
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
        
        // Initialize charts
        initializeProgressChart();
        initializeDailyChart();
    });
    
    function initializeProgressChart() {
        const ctx = document.getElementById('progressChart');
        if (!ctx) return;
        
        const progressData = {{ progress_percentage }};
        const remainingData = Math.max(0, 100 - progressData);
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'Remaining'],
                datasets: [{
                    data: [progressData, remainingData],
                    backgroundColor: [
                        {% if progress_percentage >= 100 %}'#198754'{% elif progress_percentage >= 75 %}'#0dcaf0'{% elif progress_percentage >= 50 %}'#ffc107'{% else %}'#0d6efd'{% endif %},
                        '#6c757d'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + Math.round(context.raw) + '%';
                            }
                        }
                    }
                },
                cutout: '70%'
            }
        });
    }
    
    function initializeDailyChart() {
        const ctx = document.getElementById('dailyChart');
        if (!ctx) return;
        
        {% if daily_totals %}
        const dailyData = [
            {% for day_total in daily_totals[:7] %}
            {
                date: '{{ day_total.date.strftime("%m/%d") }}',
                hours: {{ day_total.total_hours }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ].reverse();
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dailyData.map(d => d.date),
                datasets: [{
                    label: 'Hours',
                    data: dailyData.map(d => d.hours),
                    backgroundColor: '#0d6efd',
                    borderColor: '#0d6efd',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + 'h';
                            }
                        }
                    }
                }
            }
        });
        {% endif %}
    }
</script>
{% endblock %}

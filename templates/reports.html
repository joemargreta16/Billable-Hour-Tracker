{% extends "base.html" %}

{% block title %}Reports & Analytics - Time Tracker{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-0">Reports & Analytics</h1>
            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                <i data-feather="arrow-left" class="me-1"></i>Back to Dashboard
            </a>
        </div>
        <p class="text-muted">Detailed insights for {{ cycle_name }}</p>
    </div>
</div>

<!-- Date Range Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" action="{{ url_for('reports') }}" class="row g-3">
                    <div class="col-md-4">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" 
                               value="{{ request.args.get('start_date', '') }}">
                    </div>
                    <div class="col-md-4">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" 
                               value="{{ request.args.get('end_date', '') }}">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i data-feather="filter" class="me-1"></i>Apply Filter
                        </button>
                        <a href="{{ url_for('reports') }}" class="btn btn-outline-secondary">
                            <i data-feather="refresh-cw" class="me-1"></i>Reset
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i data-feather="clock" class="text-primary mb-2" style="width: 2rem; height: 2rem;"></i>
                <h4 class="mb-1">{{ decimal_to_hours_minutes(total_hours) }}</h4>
                <small class="text-muted">Total Logged</small>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i data-feather="folder" class="text-success mb-2" style="width: 2rem; height: 2rem;"></i>
                <h4 class="mb-1">{{ project_stats | length }}</h4>
                <small class="text-muted">Active Projects</small>
            </div>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="card stats-card">
            <div class="card-body text-center">
                <i data-feather="trending-up" class="text-info mb-2" style="width: 2rem; height: 2rem;"></i>
                <h4 class="mb-1">{{ "%.1f"|format((total_hours / monthly_goal * 100) if monthly_goal > 0 else 0) }}%</h4>
                <small class="text-muted">Goal Progress</small>
            </div>
        </div>
    </div>
</div>

<!-- Project Breakdown -->
<div class="row mb-4">
    <div class="col-lg-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="file-text" class="me-2"></i>Reports & Analysis Summary
                </h5>
            </div>
            <div class="card-body">
                <p>Summary of reports and analysis will be displayed here.</p>
                {% if project_stats %}
                    <ul>
                        {% for stat in project_stats %}
                            <li>{{ stat.name }}: {{ decimal_to_hours_minutes(stat.total_hours) }} logged across {{ stat.entry_count }} entries</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No project data available for this period.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Insights -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i data-feather="lightbulb" class="me-2"></i>Insights & Recommendations
                </h5>
            </div>
            <div class="card-body">
                <p>Summary of insights and recommendations will be displayed here.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        feather.replace();
        
        // Initialize charts
        initializeProjectChart();
        initializeWeeklyChart();
        initializeHourlyChart();
        
        // Set default dates if not set
        const today = new Date().toISOString().split('T')[0];
        const startDate = document.getElementById('start_date');
        const endDate = document.getElementById('end_date');
        
        if (!startDate.value) {
            // Default to start of current month if no date is set
            const firstDay = new Date();
            firstDay.setDate(1);
            startDate.value = firstDay.toISOString().split('T')[0];
        }
        
        if (!endDate.value) {
            endDate.value = today;
        }
    });
    
    function initializeProjectChart() {
        const ctx = document.getElementById('projectChart');
        if (!ctx) return;
        
        {% if project_stats %}
        const projectData = [
            {% for stat in project_stats %}
            {
                name: '{{ stat.name | replace("'", "\\'") }}',
                hours: {{ stat.total_hours }},
                entries: {{ stat.entry_count }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: projectData.map(p => p.name),
                datasets: [{
                    data: projectData.map(p => p.hours),
                    backgroundColor: [
                        '#0d6efd', '#198754', '#dc3545', '#ffc107', '#6f42c1',
                        '#fd7e14', '#20c997', '#6c757d', '#f8d7da', '#d1ecf1'
                    ],
                    borderWidth: 2,
                    borderColor: '#212529'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const data = projectData[context.dataIndex];
                                return `${context.label}: ${data.hours.toFixed(1)}h (${data.entries} entries)`;
                            }
                        }
                    }
                }
            }
        });
        {% endif %}
    }
    
    function initializeWeeklyChart() {
        const ctx = document.getElementById('weeklyChart');
        if (!ctx) return;
        
        {% if weekly_stats %}
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const weeklyData = Array(7).fill(0);
        
        {% for stat in weekly_stats %}
        weeklyData[{{ stat.day_of_week }}] = {{ stat.total_hours }};
        {% endfor %}
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dayNames,
                datasets: [{
                    label: 'Hours',
                    data: weeklyData,
                    backgroundColor: '#0d6efd',
                    borderColor: '#0d6efd',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + 'h';
                            }
                        }
                    }
                }
            }
        });
        {% endif %}
    }
    
    function initializeHourlyChart() {
        const ctx = document.getElementById('hourlyChart');
        if (!ctx) return;
        
        {% if hourly_stats %}
        const hourlyData = Array(24).fill(0);
        
        {% for stat in hourly_stats %}
        hourlyData[{{ stat.hour }}] = {{ stat.entries }};
        {% endfor %}
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 24}, (_, i) => i + ':00'),
                datasets: [{
                    label: 'Entries',
                    data: hourlyData,
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
        {% endif %}
    }

    // New chart: Project Daily Totals (Stacked Bar Chart)
    function initializeProjectDailyChart() {
        const ctx = document.getElementById('projectDailyChart');
        if (!ctx) return;

        {% if project_daily_totals %}
        // Prepare data
        const dates = [...new Set([
            {% for item in project_daily_totals %}
                '{{ item.date }}',
            {% endfor %}
        ])];

        const projects = [...new Set([
            {% for item in project_daily_totals %}
                '{{ item.name | replace("'", "\\'") }}',
            {% endfor %}
        ])];

        // Initialize dataset for each project
        const datasets = projects.map(project => {
            return {
                label: project,
                data: dates.map(date => {
                    // Convert item.date to string for comparison
                    const entry = project_daily_totals.find(item => (new Date(item.date).toISOString().split('T')[0]) === date && item.name === project);
                    return entry ? entry.total_hours : 0;
                }),
                backgroundColor: getRandomColor(),
                stack: 'Stack 0'
            };
        });

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dates,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                }
            }
        });
        {% endif %}
    }

    // New chart: Daily Totals Heatmap (simple color-coded bar chart)
    function initializeDailyTotalsHeatmap() {
        const ctx = document.getElementById('dailyTotalsHeatmap');
        if (!ctx) return;

        {% if daily_totals %}
        const dates = [
            {% for item in daily_totals %}
                '{{ item.date }}',
            {% endfor %}
        ];

        const totals = [
            {% for item in daily_totals %}
                {{ item.total_hours }},
            {% endfor %}
        ];

        // Map totals to colors (simple gradient from light to dark)
        const maxTotal = Math.max(...totals);
        const backgroundColors = totals.map(total => {
            const intensity = Math.floor((total / maxTotal) * 255);
            return `rgba(13, 110, 253, ${intensity / 255})`;
        });

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Total Hours',
                    data: totals,
                    backgroundColor: backgroundColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 90,
                            minRotation: 45
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
        {% endif %}
    }

    // Utility function to generate random colors for charts
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }
</script>
{% endblock %}
